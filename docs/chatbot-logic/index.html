<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<title data-react-helmet="true">Chatbot Logic | Chatbot for Class</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Chatbot Logic | Chatbot for Class"><meta data-react-helmet="true" name="description" content="Now, it&#x27;s time to add some code to hook up all these things together! You&#x27;ll need a Node.js app to make a bridge between Facebook app and Wit.ai App."><meta data-react-helmet="true" property="og:description" content="Now, it&#x27;s time to add some code to hook up all these things together! You&#x27;ll need a Node.js app to make a bridge between Facebook app and Wit.ai App."><meta data-react-helmet="true" property="og:url" content="https://romanenko.github.com/covid19-safety-information/covid19-safety-information/docs/chatbot-logic"><link data-react-helmet="true" rel="shortcut icon" href="/covid19-safety-information/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://romanenko.github.com/covid19-safety-information/covid19-safety-information/docs/chatbot-logic"><link rel="stylesheet" href="/covid19-safety-information/styles.471e7c99.css">
<link rel="preload" href="/covid19-safety-information/styles.d9901f3b.js" as="script">
<link rel="preload" href="/covid19-safety-information/runtime~main.35cf3564.js" as="script">
<link rel="preload" href="/covid19-safety-information/main.91bccc4a.js" as="script">
<link rel="preload" href="/covid19-safety-information/1.2251aac1.js" as="script">
<link rel="preload" href="/covid19-safety-information/19.d736edad.js" as="script">
<link rel="preload" href="/covid19-safety-information/20.32df9d38.js" as="script">
<link rel="preload" href="/covid19-safety-information/935f2afb.9c35d9be.js" as="script">
<link rel="preload" href="/covid19-safety-information/18.622075d5.js" as="script">
<link rel="preload" href="/covid19-safety-information/726ffc6b.a26ee78c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/covid19-safety-information/"><img src="/covid19-safety-information/img/logo.svg" alt="Chatbot for Class" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/covid19-safety-information/img/logo.svg" alt="Chatbot for Class" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Chatbot for Class</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/covid19-safety-information/docs/">Get Started</a><a href="http://m.me/111708907337870" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Try it out</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/romanenko/covid19-safety-information" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/covid19-safety-information/"><img src="/covid19-safety-information/img/logo.svg" alt="Chatbot for Class" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/covid19-safety-information/img/logo.svg" alt="Chatbot for Class" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Chatbot for Class</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/covid19-safety-information/docs/">Get Started</a></li><li class="menu__list-item"><a href="http://m.me/111708907337870" target="_blank" rel="noopener noreferrer" class="menu__link">Try it out</a></li><li class="menu__list-item"><a href="https://github.com/romanenko/covid19-safety-information" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Building</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/plan">Planning the Work</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/wit-ai">Training Wit.ai</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/facebook-page">Facebook Page</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/facebook-app">Facebook App</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/covid19-safety-information/docs/chatbot-logic">Chatbot Logic</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/covid19-safety-information/docs/testing">Testing your Chatbot</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Future Directions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/covid19-safety-information/docs/ideas">Ideas on What to Do Next</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/covid19-safety-information/docs/learn-more">Keep Learning</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Chatbot Logic</h1></header><div class="markdown"><p>Now, it&#x27;s time to add some code to hook up all these things together! You&#x27;ll need a Node.js app to make a bridge between Facebook app and <a href="http://wit.ai" target="_blank" rel="noopener noreferrer">Wit.ai</a> App. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="node-app"></a>Node App<a class="hash-link" href="#node-app" title="Direct link to heading">#</a></h2><p>No need to worry, there is a base code in the <a href="https://glitch.com/~covid-19-bot-tutorial" target="_blank" rel="noopener noreferrer">Glitch</a> and you can simply copy the whole project with &quot;<strong>Remix Project</strong>&quot; button and adjust it as you want. It is going to be a project with same code but act as a unique Application with its own set of environment variables.</p><p><img alt="../static/img/article/Screen_Shot_2020-10-25_at_5.21.47_PM.png" src="/covid19-safety-information/assets/images/Screen_Shot_2020-10-25_at_5.21.47_PM-9870fccf6533e0622ee9daf634b9c28f.png"></p><p>It is a relatively simple Node.js app, which acts as a server to respond to requests, coming from the Facebook App. It handles two types of requests:</p><ul><li><code>GET /webhook</code> ‚Äî to setup and verify a webhook URL</li><li><code>POST /webhook</code> ‚Äî to receive, process and respond to incoming messages</li></ul><p>The app consists of four main modules:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="appjs---app-entry-point"></a>app.js - App entry point<a class="hash-link" href="#appjs---app-entry-point" title="Direct link to heading">#</a></h3><p>This is where Express server and <a href="http://wit.ai" target="_blank" rel="noopener noreferrer">Wit.ai</a> connection sets up and main two webhook request handlers are implemented.</p><p>The most notable part is the message handler code:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-js codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Retreiving unique sender id to identify user across different calls</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sender </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Define messages as array of objects</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// with required `text` parameter for the message</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// and a possible `meta` field with potential additional configuration</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// to enhance the message with attachments or Quick Replies in the future</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Setting it with default message to provide usage guide for new users</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">let</span><span class="token plain"> messages </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;You can ask me for advice whether it is safe to perform an activity in COVID-19 pandemic times. For example: &quot;Is it safe to go to a restaurant?&quot;&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Fetching the quiz session object, associated with the sender</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// to understand whether you are in the process of quiz </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> currentQuiz </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> quiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRunningQuiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">currentQuiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// If you are ‚Äî pass the inbound text to the handler function </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// to continue or to end the ongoing quiz</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  messages </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> quiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">handleQuizAnswer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">currentQuiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Otherwize ‚Äî pass the text to WIT.AI to recongize intent and activity from it</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> intents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> entities </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> wit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">intents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> topIntent </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> intents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      topIntent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;safety_info&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">isArray</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">entities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;activity:activity&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> activity </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> entities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;activity:activity&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// If recognized intent has the name &quot;safety_info&quot; and &quot;activity:activity&quot; entity </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// accociated with it - start a new quiz, with current user and activity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      messages </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> quiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">startQuiz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> activity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Deliver the message to the user</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> messenger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">sendMessages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="quizjs"></a>quiz.js<a class="hash-link" href="#quizjs" title="Direct link to heading">#</a></h3><p>This is the module, you are free to customize. It has the Quiz Q&amp;A data:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-js codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> quizSteps </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    columnName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Masks&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    question</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;How likely you and people around you will wear a mask?&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    quickReplies</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üôÇ Not likely&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ü§∑‚Äç‚ôÄÔ∏è Maybe&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üò∑ Definitely&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    columnName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Crowds&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    question</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;How crowded the place will be?&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    quickReplies</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ Crowded&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üë´ Maybe&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üßç‚Äç‚ôÄÔ∏è Not at all&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    columnName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Air&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    question</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;How enclosed the space will be around you?&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    quickReplies</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üè° Enclosed&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;üèï Maybe&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ü§∏‚Äç‚ôÄÔ∏è Not at all&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Where each step of it has a <code>question</code> and set of <code>quickReplies</code> to suggest to the User. Field <code>columnName</code> represents the name of the column in Airtable, used to store the answer, while User goes through the Quiz. Values, stored in the table are integers in range of 1-3.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dbjs-and-messengerjs"></a>db.js and messenger.js<a class="hash-link" href="#dbjs-and-messengerjs" title="Direct link to heading">#</a></h3><p>These modules are used to help establish communication with Facebook Messenger Platform and Airtable API and to provide handy functions to perform basic operations ‚Äî send messages, retrieve or update a record in Airtable database.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="environment-variables"></a>Environment Variables<a class="hash-link" href="#environment-variables" title="Direct link to heading">#</a></h2><p>Variables which get to set in the environment of the app, before it gets executed. Values then are used in code ‚Äî this is a common practice to keep secret keys separate from the codebase.</p><p>In this project you can control them by modifying the <code>.env</code> file and Glitch has a neat UI to manage it:</p><p><img alt="../static/img/article/Untitled.png" src="/covid19-safety-information/assets/images/Untitled-fc769d9ef141e4320ba2891a9e077320.png"></p><p>Now, you are going to fill in the environment variables which are required to connect Facebook app and <a href="http://wit.ai" target="_blank" rel="noopener noreferrer">Wit.ai</a> app.</p><p>First, let&#x27;s get the app secret. Let&#x27;s go to your Facebook app ‚Üí Settings ‚Üí Basic. Copy and paste the <strong>App Secret</strong> in the FB_APP_SECRET of the Glitch <code>.env</code>. It may require your facebook password to get <strong>App Secret</strong> for the first time. </p><p><img alt="../static/img/article/2020-10-25_18.12.38.gif" src="/covid19-safety-information/assets/images/2020-10-25_18.12.38-347f5e3f8f00d31ad12ccaa7c0e59c1a.gif"></p><p>Then, let&#x27;s get the <strong>WIT_TOKEN</strong>. Go to your <a href="http://wit.AI" target="_blank" rel="noopener noreferrer">Wit.ai</a> app, copy <strong>Server Access</strong> token and paste it in the  <strong>WIT_TOKEN</strong> of the Glitch <code>.env</code></p><p><img alt="../static/img/article/2020-10-25_18.16.38.gif" src="/covid19-safety-information/assets/images/2020-10-25_18.16.38-1ecdbaa46d1275463e41cd6bf7928b76.gif"></p><p>You also need to provide other environment variables such as <strong>FB_PAGE_TOKEN</strong>, <strong>FB_VERIFY_TOKEN</strong>, <strong>AIRTABLE_API_KEY</strong>, <strong>AIRTABLE_DB_NAME</strong>. We can just type random values for these variables temporarily. </p><p>Go to your Facebook App ‚Üí Messenger ‚Üí Settings and generate click &quot;Add callback URL&quot;.  You can find callback URL in Glitch ‚Üí Share ‚Üí Live app. Paste it and don&#x27;t forget to add &quot;/webhook&quot; to the end of the url.</p><p><img alt="../static/img/article/2020-10-25_19.19.29.gif" src="/covid19-safety-information/assets/images/2020-10-25_19.19.29-b0782d6e9048b154d77022b756dce61f.gif"></p><p>The last step is <strong>FB_PAGE_TOKEN</strong>. Go to your Facebook app ‚Üí Messenger ‚Üí Settings and generate the token. Remove your previous <strong>FB_PAGE_TOKEN</strong> and paste the token.</p><p><img alt="../static/img/article/2020-10-25_19.24.35.gif" src="/covid19-safety-information/assets/images/2020-10-25_19.24.35-948936cf773a523bc84ae2a8944c1725.gif"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="airtable"></a>Airtable<a class="hash-link" href="#airtable" title="Direct link to heading">#</a></h2><p>Every time your Node app receives the message ‚Äî you should assume it might be unaware of all previous actions. To keep it in context of ongoing conversation you have to keep the state of it in some <strong>persistence layer.</strong> </p><p>Some apps doesn&#x27;t require having one, but conversational apps usually do. In this case, you will keep quiz progress across the dialog events and remove it, once the quiz is completed ‚Äî you don&#x27;t need to keep any extra data after it.</p><p>You will use <a href="https://airtable.com/" target="_blank" rel="noopener noreferrer">Airtable</a> as a simple service to store session data for ongoing quizzes and access it with its handy JavaScript library.</p><p>Start by signing up for an Airtable account and creating a Workspace.</p><p><img alt="../static/img/article/CleanShot_2020-10-26_at_19.32.36.gif" src="/covid19-safety-information/assets/images/CleanShot_2020-10-26_at_19.32.36-ea06c5c68d7b9ade0a470a78544ee7fa.gif"></p><p>Next, create a Base. Choose <strong>&quot;Start from scratch&quot;</strong> and give it a name:</p><p><img alt="../static/img/article/CleanShot_2020-10-26_at_19.36.05.gif" src="/covid19-safety-information/assets/images/CleanShot_2020-10-26_at_19.36.05-535327335c0ec259b0a0d203cb6697a9.gif"></p><p>Your database will have a table, created for you by default:</p><p><img alt="../static/img/article/airtable1.png" src="/covid19-safety-information/assets/images/airtable1-6ffa9559c433e62c8778c397f0c62612.png"></p><p>You can keep it, but change it for your needs. Change the name of the table to <strong>&quot;Quizzes&quot;</strong> and configure four columns with the following configuration:</p><ul><li><strong>SessionId</strong> ‚Äî Single line text</li><li><strong>Activity</strong> ‚Äî Single line text</li><li><strong>Masks</strong> ‚Äî Rating, Max 3 stars</li><li><strong>Crowds</strong> ‚Äî Rating, Max 3 stars</li><li><strong>Air</strong> ‚Äî Rating, Max 3 stars</li></ul><p>This is what end result should look like:</p><p><img alt="../static/img/article/airtable2.png" src="/covid19-safety-information/assets/images/airtable2-61d71c6ad8add15a0ceb357b3630f61d.png"></p><p>Now, to connect this table to your Glitch app, you&#x27;ll need to get its Base id and API Key. The easiest way to get them is to take a peek to its dynamically generated API documentation.</p><p>Navigate to: <a href="https://airtable.com/api" target="_blank" rel="noopener noreferrer">https://airtable.com/api</a> and select a Base to view its API documentation. </p><p>Scroll down to <strong>&quot;Authentication&quot;</strong> section, switch to &quot;JavaScript&quot; and turn on &quot;show API key&quot; checkbox:</p><p><img alt="../static/img/article/airtable3.png" src="/covid19-safety-information/assets/images/airtable3-97486ddc5ae87d8177b6147c8b5a9e3b.png"></p><p>Let&#x27;s copy these values and paste them to your <code>.env</code> ****file in the Glitch app:</p><p><img alt="../static/img/article/airtable4.png" src="/covid19-safety-information/assets/images/airtable4-051d7fcb8e001dd71e7a0e79c1380e04.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/romanenko/covid19-safety-information/tree/main/docs/docs/chatbot-logic.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/covid19-safety-information/docs/facebook-app"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Facebook App</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/covid19-safety-information/docs/testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Testing your Chatbot ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#node-app" class="table-of-contents__link">Node App</a><ul><li><a href="#appjs---app-entry-point" class="table-of-contents__link">app.js - App entry point</a></li><li><a href="#quizjs" class="table-of-contents__link">quiz.js</a></li><li><a href="#dbjs-and-messengerjs" class="table-of-contents__link">db.js and messenger.js</a></li></ul></li><li><a href="#environment-variables" class="table-of-contents__link">Environment Variables</a></li><li><a href="#airtable" class="table-of-contents__link">Airtable</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Guide</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/covid19-safety-information/docs/">Chatbot for Class</a></li><li class="footer__item"><a class="footer__link-item" href="/covid19-safety-information/docs/ideas/">Future directions</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/covid19-safety-information/docs/privacy-policy">Privacy Policy</a></li><li class="footer__item"><a class="footer__link-item" href="/covid19-safety-information/docs/terms-of-service">Terms of Service</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/romanenko/covid19-safety-information" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright ¬© 2020 <a href="https://github.com/janeshin059">Jane Hyeseo Shin</a>, <a href="https://michael.romanenko.kg/">Michael Romanenko</a>.<br> Built with <a href="https://docusaurus.io/">Docusaurus</a>. Landing images by <a href="https://undraw.co/">unDraw</a></div></div></div></footer></div>
<script src="/covid19-safety-information/styles.d9901f3b.js"></script>
<script src="/covid19-safety-information/runtime~main.35cf3564.js"></script>
<script src="/covid19-safety-information/main.91bccc4a.js"></script>
<script src="/covid19-safety-information/1.2251aac1.js"></script>
<script src="/covid19-safety-information/19.d736edad.js"></script>
<script src="/covid19-safety-information/20.32df9d38.js"></script>
<script src="/covid19-safety-information/935f2afb.9c35d9be.js"></script>
<script src="/covid19-safety-information/18.622075d5.js"></script>
<script src="/covid19-safety-information/726ffc6b.a26ee78c.js"></script>
</body>
</html>